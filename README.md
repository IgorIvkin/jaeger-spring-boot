# Трассировка с помощью Spring Boot и Jaeger

Трассировка в распределённых системах - это процесс отслеживания пошагового
выполнения запроса. Ваш запрос может пройти через много сервисов, потому что
ему могут потребоваться данные от других систем, баз данных и других узлов.

Инженерам по сопровождению очень важно знать, как шёл запрос, где он оборвался
и что ему помешало. При отладке инцидентов в распределенной системе любой разбор
начинается с определения виновной части системы, а уж только затем идёт изучение
проблемного узла.

Таким образом, трассировка позволяет обеспечить наблюдаемость и ускоряет отладку
проблем в любой распределённой системе.

## Opentracing

Opentracing - это открытый формат описания трассировки. Это спецификация, которая 
описывает, как в распределенной системе должна происходить трассировка. У спецификации
Opentracing есть несколько реализаций, одна из самых известных - **Jaeger**.

### Терминология

Выделяют следующие важные понятия:
1. Трейс (trace) - это путь исполнения запроса, проходящий через один или много вычислительных 
узлов. В трейсе могут присутствовать базы данных, очереди сообщений и другие средства. У каждого трейса
должен быть уникальный идентификатор, позволяющий отличить один трейс от другого.
2. Спан (span) - это один отрезок исполнения запроса, то есть один из шагов в трейсе. У каждого спана тоже
есть собственный уникальный идентификатор. Трейс состоит из спанов и содержит цепочку идентификаторов
спанов в таком порядке, в каком исполнялся запрос.


### Устройство Jaeger 

Jaeger представляет собой систему, состоящую из узлов нескольких типов.

### Агент Jaeger
Агент - это небольшое приложение, которое должно работать где-то поблизости
от вашей программы. Оно слушает определенный порт и предназначено для того, чтобы
получать сообщения о трейсах и отправлять их в коллектор.

### Коллектор Jaeger
Коллектор - это большое приложение, которое предназначено для приёма трейсов
от агентов и сохранения их в базе данных. По умолчанию Jaeger тяготеет к сохранению
трейсов в Cassandra, но в нашем учебном примере мы будем использовать компактное
встроенное хранилище **Bagder**.

### Query-tool

Этот компонент представляет собой UI, который позволяет просматривать и изучать
трейсы. Его еще называют Jaeger UI.

## Как работать с Jaeger Opentracing в Spring Boot

У Spring Boot хорошая интеграция с Jaeger. Всё, что нужно сделать для работы - это
добавить зависимости и настроить приложение в `application.yml`.

В данном примере вам будет нужна следующая зависимость (имейте в виду,
что есть и другие варианты настройки).

```xml
<dependency>
    <groupId>io.opentracing.contrib</groupId>
    <artifactId>opentracing-spring-jaeger-cloud-starter</artifactId>
    <version>3.3.1</version>
</dependency>
```

В `application.yml` вам нужно настроить две важные вещи. Во-первых, дайте
своему приложению какое-то имя. Оно будет отображаться как имя сервиса в Jaeger
UI. Во-вторых, укажите, куда приложение должно отправлять трейсы. Это будет
адрес и порт агента или коллектора трейсов.

```yaml
spring:
  application:
    name: master-application

opentracing:
  enable-b3-propagation: true
  jaeger:
    udp-sender:
      host: localhost
      port: 6831

```

Специальная настройка `enable-b3-propagation` задает возможность добавлять
к каждому запросу B3-заголовки, что обеспечивает совместимость со стандартом
Zipkin.

### Как запустить и посмотреть

Проект содержит две директории, `docker` и `demo-applications`. В папке `docker`
находится файл `docker-compose.yml`, в котором находятся настройки для запуска
контейнера, содержащего в себе агент, коллектор, сохраняющий трейсы во встроенное
хранилище, а также веб-UI, позволяющий изучать трейсы.

Вам достаточно запустить docker-compose с помощью

`docker-compose up -d`

В папке `demo-applications` находятся два приложения на Spring Boot. Одно называется
`master-application`, а другое - `service-application`. Вам нужно запустить оба эти приложения 
и обратиться к контроллеру master-application. Например, так:

`GET http://localhost:8081/access-external-system`

Первое приложение вызовет второе, а трассировка

Далее вы можете зайти по адресу [http://localhost:16686](http://localhost:16686)
и изучить консоль Jaeger UI. Там в левом меню можно выбирать сервисы с нужным именем и
изучать трассировки, связанные с ними.
